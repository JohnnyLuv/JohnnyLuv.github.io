---
title: react redux ç”¨ä¾‹ç”±ç¹åˆ°ç®€
date: 2021-07-29 15:05:15
categories: JavaScript
tags: [react, redux, hooks]
---

## å†™åœ¨å‰é¢

è¿™ç¯‡é€šè¿‡ç®€å•çš„è®¡æ•°å™¨æ¡ˆä¾‹ï¼Œè®°å½•ä¸‹ `react-redux` å…¨å±€çŠ¶æ€çš„åˆ›å»ºï¼Œå’ŒåŒæ­¥ã€å¼‚æ­¥æ›´æ–°çŠ¶æ€çš„å‡ ç§ä¸åŒçš„å®ç°æ–¹å¼ã€‚é¡¹ç›®ä¸­`v1ã€v2ã€v3`ä¸‰ä¸ªå­ç»„ä»¶æœ¬å…±ç”¨ä¸€å¥— `state` å’Œ `actions`

æœ€åè§†å›¾å¤§æ¦‚æ˜¯è¿™æ ·çš„

![finish-views](https://git.code.tencent.com/JohnnyLuv/static-resource/raw/a7a6d5650113f4766e20acd0d74a310969957b38/2021/07/views.png)

é¡¹ç›®åœ°å€ï¼š[https://github.com/JohnnyLuv/react-redux-easy-demo](https://github.com/JohnnyLuv/react-redux-easy-demo)

## å‚è€ƒæ–‡æ¡£

- ğŸŒˆ redux apiï¼š[https://cn.redux.js.org](https://cn.redux.js.org)
- ğŸŒˆ react-redux apiï¼š[https://react-redux.js.org](https://react-redux.js.org)
- ğŸŒˆ redux-toolkit apiï¼š[https://redux-toolkit.js.org](https://redux-toolkit.js.org)

æ—¶é—´2021å¹´7æœˆï¼Œå®˜æ–¹è¿™ä¹ˆè¯´çš„

> æˆ‘ä»¬ç°åœ¨å»ºè®®é»˜è®¤ä½¿ç”¨`React-Redux hooks API`ã€‚ä½†æ˜¯ï¼Œ`connect API` ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚
> ä¸å†æ¨èæ—§çš„æ–¹æ³•ï¼Œæ¯”å¦‚å°†`Redux`é€»è¾‘æŒ‰ç±»å‹åˆ’åˆ†åˆ°æ–‡ä»¶å¤¹ä¸­ã€‚
> â€”â€” Redux

## åˆå§‹åŒ–é¡¹ç›®

ä½¿ç”¨`npm`åˆ›å»º

```bash
$ npx create-react-app my-app
$ cd my-app
$ npm i react-redux @reduxjs/toolkit
$ npm run start
```

æˆ–è€…`yarn`

```bash
$ yarn create react-app my-app
$ cd my-app
$ yarn add react-redux @reduxjs/toolkit
$ yarn start
```

`package.json`ä¾èµ–é¡¹å’Œç‰ˆæœ¬å‚è€ƒå¦‚ä¸‹

```js
"dependencies": {
  "@reduxjs/toolkit": "^1.6.1",
  "@testing-library/jest-dom": "^5.14.1",
  "@testing-library/react": "^12.0.0",
  "@testing-library/user-event": "^13.2.0",
  "react": "^17.0.2",
  "react-dom": "^17.0.2",
  "react-redux": "^7.2.4",
  "react-scripts": "4.0.3"
},
```

åˆ æ‰ä¸€äº›æˆ‘ä»¬ä¸éœ€è¦çš„æ–‡ä»¶ï¼Œå¹¶åˆ›å»º `redux` çš„ä»“åº“(`store`)ã€åˆ‡ç‰‡(`slice`)ä»¥åŠè§†å›¾ç»„ä»¶(`components`)

å¾—åˆ°é¡¹ç›®ç»“æ„å‚è€ƒå¦‚ä¸‹

```js
project
â”œâ”€â”€ node_modules
â”œâ”€â”€ public
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ app
â”‚   â”‚   â””â”€â”€ store.js
â”‚   â”œâ”€â”€ features
â”‚   â”‚   â””â”€â”€ counter
â”‚   â”‚       â”œâ”€â”€ counterSlice.js
â”‚   â”‚       â”œâ”€â”€ CounterV1.js
â”‚   â”‚       â”œâ”€â”€ CounterV2.js
â”‚   â”‚       â””â”€â”€ CounterV3.js
â”‚   â”œâ”€â”€ App.js
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## å¼€å§‹æ„å»º

### åˆ‡ç‰‡(slice)

ä¸ç®¡ä»¥ä»€ä¹ˆç»´åº¦æ¥ç»„ç»‡çŠ¶æ€åˆ‡ç‰‡ï¼Œå¯¹å¯ç»´æŠ¤æ€§éƒ½æ˜¯æœ‰ç›Šçš„

```js
// project/src/features/counter/counterSlice.js

import { createSlice } from '@reduxjs/toolkit'

export const counterSlice = createSlice({
  name: 'counter', // å¯ç”¨å‘½åç©ºé—´
  initialState: {
    value: 0,
  },
  reducers: {
    // Redux Toolkit å…è®¸æˆ‘ä»¬åœ¨ reducer ä¸­ç¼–å†™ "mutating" é€»è¾‘
    // å®ƒå®é™…ä¸Šå¹¶ä¸æ”¹å˜çŠ¶æ€ï¼Œå› ä¸ºå®ƒä½¿ç”¨ Immer åº“
    // å®ƒæ£€æµ‹åˆ° "draft state" çš„å˜åŒ–ï¼Œå¹¶åŸºäºè¿™äº›å˜åŒ–äº§ç”Ÿä¸€ä¸ªå…¨æ–°çš„ä¸å¯å˜çŠ¶æ€
    decrement: state => {
      state.value -= 1
    },
    increment: state => {
      state.value += 1
    },
    incrementByAmount: (state, action) => {
      state.value += Number(action.payload)
    },
  },
})

export const { increment, decrement, incrementByAmount } = counterSlice.actions

// ä¸‹é¢çš„å‡½æ•°è¢«ç§°ä¸º thunk ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ‰§è¡Œå¼‚æ­¥é€»è¾‘
// å®ƒå¯ä»¥åƒå¸¸è§„åŠ¨ä½œä¸€æ ·åˆ†æ´¾: `dispatch(incrementAsync(10))`
// è¿™å°†ä»¥ `dispatch` å‡½æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°è°ƒç”¨ thunk
// ç„¶åå¯ä»¥æ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œå¹¶åˆ†æ´¾å…¶ä»–æ“ä½œ
export const incrementAsync = amount => dispatch => {
  setTimeout(() => {
    dispatch(incrementByAmount(amount))
  }, 1000)
}

// ä¸‹é¢çš„å‡½æ•°è¢«ç§°ä¸ºé€‰æ‹©å™¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»çŠ¶æ€ä¸­é€‰æ‹©ä¸€ä¸ªå€¼
// é€‰æ‹©å™¨ä¹Ÿå¯ä»¥åœ¨ä½¿ç”¨å®ƒä»¬çš„åœ°æ–¹å†…è”å®šä¹‰ï¼Œè€Œä¸æ˜¯åœ¨ slice æ–‡ä»¶ä¸­
// ä¾‹å¦‚: `useSelector((state) => state.counter.value)`
export const selectCount = state => state.counter.value

export default counterSlice.reducer
```

### ä»“åº“(store)

åˆ›å»º `store` å…¨å±€çŠ¶æ€ä»“åº“ï¼Œå¹¶å…³è”åˆ‡ç‰‡

```js
// project/src/app/store.js

import { configureStore } from '@reduxjs/toolkit'
import counterReducer from '../features/counter/counterSlice'

export default configureStore({
  reducer: {
    counter: counterReducer,
  },
})
```

### æŒ‚è½½storeåˆ°å…¥å£æ–‡ä»¶

åˆ°è¿™é‡Œ `redux` çš„ `store` å·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥åˆ°ç»„ä»¶ä¸­å»ä½¿ç”¨

```js
// project/src/index.js

import ReactDOM from 'react-dom'
import App from './App'
import { Provider } from 'react-redux'
import store from './app/store'

ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById('root')
)
```

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

ç¼–è¾‘æ ¹ç»„ä»¶ï¼Œå­ç»„ä»¶æˆ‘ä»¬åˆ†ä¸‰ä¸ªç‰ˆæœ¬æ¥å†™ï¼Œå¯¹åº”ä¸åŒçš„ç”¨æ³•

```js
// project/src/App.js

import CounterV1 from './features/counter/CounterV1'
import CounterV2 from './features/counter/CounterV2'
import CounterV3 from './features/counter/CounterV3'

function App() {
  return (<>
    <CounterV1 />
    <hr />
    <CounterV2 />
    <hr />
    <CounterV3 />
  </>)
}

export default App
```

é¦–å…ˆæ˜¯ `CounterV1` ç‰ˆæœ¬ï¼Œæ˜¯æ—©æœŸçš„ç”¨æ³•ï¼Œä¹Ÿæ˜¯æœ€è‡ƒè‚¿çš„ä¸€ç§

é€šè¿‡ `connect` åŒ…è£…å­ç»„ä»¶ï¼Œä½¿å…¶å¯ä»¥æ³¨å…¥ä¸šåŠ¡åˆ‡ç‰‡çš„çŠ¶æ€å’Œæ–¹æ³•

```js
// project/src/features/counter/CounterV1.js

import { useState } from 'react'
import { connect } from 'react-redux'
import {
  decrement,
  increment,
  incrementByAmount,
  incrementAsync,
} from './counterSlice'

function Main(props) {
  const [stepNum, setStepNum] = useState(1)

  return (<>
    <h3>counter v1</h3>
    <div>
      <button children='-' onClick={props.sendDecrement} />
      <span> {props.counter.value} </span>
      <button children='+' onClick={props.sendIncrement} />
    </div>
    <div>
      <input value={stepNum} onChange={e => setStepNum(e.target.value)} type='number' placeholder='step' />
      <button children='Add Amount' onClick={() => props.sendIncrementByAmount(stepNum)} />
      <button children='Add Async' onClick={() => props.sendIncrementAsync(stepNum)} />
    </div>
  </>)
}

const mapStateToProps = state => state
function mapDispatchToProps(dispatch) {
  return {
    sendDecrement: () => dispatch(decrement()),
    sendIncrement: () => dispatch(increment()),
    sendIncrementByAmount: num => dispatch(incrementByAmount(num)),
    sendIncrementAsync: num => dispatch(incrementAsync(num))
  }
}

export default connect(mapStateToProps, mapDispatchToProps)(Main)
```

æ¥ç€æ˜¯ `CounterV2` ç‰ˆæœ¬ï¼Œ

è¿™ä¸€ç‰ˆæˆ‘ä»¬å¼•å…¥äº† redux-hooks çš„å†™æ³•ï¼Œä¸ç”¨å†é åŒ…è£…å­ç»„ä»¶æ¥è·å–å…¨å±€çŠ¶æ€ï¼Œå¯è¯»æ€§è¾ƒ `CounterV2` æé«˜ä¸å°‘

```js
// project/src/features/counter/CounterV2.js

import { useState } from 'react'
import { useSelector, useDispatch } from 'react-redux'
import {
  decrement,
  increment,
  incrementByAmount,
  incrementAsync,
  selectCount,
} from './counterSlice'

export default function Counter() {
  const count = useSelector(selectCount)
    , dispatch = useDispatch()

  const [stepNum, setStepNum] = useState(10)

  return (<>
    <h3>counter v2</h3>
    <div>
      <button onClick={() => dispatch(decrement())} children='-' />
      <span> {count} </span>
      <button onClick={() => dispatch(increment())} children='+' />
    </div>
    <div>
      <input value={stepNum} onChange={e => setStepNum(e.target.value)} type='number' placeholder='step' />
      <button onClick={() => dispatch(incrementByAmount(stepNum))} children='Add Amount' />
      <button onClick={() => dispatch(incrementAsync(stepNum))} children='Add Async' />
    </div>
  </>)
}
```

ç¬¬ä¸‰ç‰ˆ `CounterV2` ç»§ç»­ç®€åŒ–ä»£ç ï¼Œä½¿ç”¨å‘½åç©ºé—´çš„æ–¹å¼ï¼Œæ¥å‘ä»“åº“åˆ‡ç‰‡æäº¤å‡½æ•°å’Œè½½è·

```js
// project/src/features/counter/CounterV3.js

import { useState } from 'react'
import { useSelector, useDispatch } from 'react-redux'
import { incrementAsync } from './counterSlice'

export default function Counter() {
  const { counter } = useSelector(state => state)
    , dispatch = useDispatch()

  const [stepNum, setStepNum] = useState(100)

  return (<>
    <h3>counter v3</h3>
    <div>
      <button onClick={() => dispatch({ type: 'counter/decrement' })} children='-' />
      <span> {counter.value} </span>
      <button onClick={() => dispatch({ type: 'counter/increment' })} children='+' />
    </div>
    <div>
      <input value={stepNum} onChange={e => setStepNum(e.target.value)} type='number' placeholder='step' />
      <button onClick={() => dispatch({ type: 'counter/incrementByAmount', payload: stepNum })} children='Add Amount' />
      <button onClick={() => dispatch(incrementAsync(stepNum))} children='Add Async' />
    </div>
  </>)
}
```

### æœ€å

åˆ°è¿™é‡Œé¡¹ç›®å°±æ„å»ºå®Œæˆäº†ï¼Œå¯ä»¥çœ‹ä¸‹è§†å›¾ä¸ŠçŠ¶æ€å’Œæ“ä½œçš„æ•ˆæœ

è¿˜æœ‰ä¸€ä¸ªæœªè§£å†³çš„é—®é¢˜ï¼Œå°±æ˜¯ å¼‚æ­¥ `actions` çš„ `thunk` ä½¿ç”¨å‘½åç©ºé—´å†™æ³•æ²¡æœ‰ç”Ÿæ•ˆï¼Œæš‚æ—¶æ²¡æœ‰æƒ³æ˜ç™½åŸå› 

ç”±äºä¹‹å‰çš„è€é¡¹ç›®æ˜¯ç”¨ `connect API` å†™çš„ï¼Œæ¯”è¾ƒç¹çå’Œè‡ƒè‚¿ã€‚æ–°é¡¹ç›®å®Œå…¨å¯ä»¥ç”¨ `hooks API` æ¥å†™

`react` ç”Ÿæ€çš„ `hooks` æ˜¯å€¼å¾—æ¨èçš„ï½

**done** ğŸ‰
